# Ekoyka: Техническое задание на разработку backend-системы управления психиатрической больницей

## 1. Описание проекта
Проект представляет собой REST API на FastAPI для управления психиатрической больницей. Основные функции включают регистрацию пациентов, их госпитализацию, ведение медицинской карты, выписку и управление пользователями с различными ролями.

### 1.1 Flow работы системы
1. **Регистрация и авторизация**
    - Администратор регистрирует новых пользователей (врачи, медсестры, пациенты).
    - Пользователь входит в систему через JWT-токен.

2. **Добавление пациента**
    - Врач или медсестра регистрируют пациента в системе.
    - Указываются личные данные, контактная информация и начальный статус (зарегистрирован).

3. **Госпитализация пациента**
    - Врач госпитализирует пациента, меняя его статус на "госпитализирован".
    - Фиксируется дата поступления, ответственный врач и предварительный диагноз.

4. **Ведение медицинской карты**
    - Врач или медсестра добавляют записи в медицинскую карту пациента.
    - Записи включают диагнозы, назначенное лечение и комментарии врача.

5. **Выписка пациента**
    - Врач оформляет выписку пациента, указывая дату и итоговый диагноз.
    - Пациенту присваивается статус "выписан".

6. **Просмотр и редактирование информации**
    - Врачи и медсестры могут просматривать и редактировать данные пациентов.
    - Пациенты могут видеть только свою медицинскую карту.

## 2. Технологический стек
- **Язык программирования**: Python 3.11+
- **Фреймворк**: FastAPI
- **База данных**: PostgreSQL
- **ORM**: SQLAlchemy + Alembic (для миграций)
- **Контейнеризация**: Docker
- **Аутентификация**: JWT (OAuth2 с Password Flow)
- **Логирование**: structlog
- **Тестирование**: pytest

## 3. Функциональные требования
### 3.1. Авторизация и управление пользователями
#### Роли пользователей:
- **Администратор** (управляет пользователями, больницей, доступом)
- **Врач** (может регистрировать пациентов, госпитализировать, выписывать, просматривать карты пациентов)
- **Медсестра** (просматривает список пациентов, фиксирует изменения в карте)
- **Пациент** (может видеть свою карту и статус госпитализации)

#### Функции:
- Регистрация пользователя (только админ)
- Авторизация через JWT
- Просмотр своего профиля
- Изменение пароля
- Управление пользователями (CRUD для админа)

### 3.2. Управление пациентами
- Регистрация пациента
- Просмотр информации о пациенте
- Обновление данных пациента
- Удаление пациента (только админ)

### 3.3. Госпитализация
- Госпитализация пациента
- Изменение статуса пациента (госпитализирован, на лечении, выписан)
- Добавление записей в историю болезни
- Выписка пациента

### 3.4. Медицинская карта
- Хранение диагноза, истории болезни, назначений
- Добавление записей в карту
- Просмотр карты (врач, медсестра, пациент)

## 4. API-эндпоинты
### 4.1. Аутентификация и пользователи
- `POST /auth/register` – регистрация пользователя
- `POST /auth/login` – вход в систему (JWT)
- `GET /auth/me` – получение информации о себе
- `POST /auth/logout` – выход из системы
- `PUT /users/{user_id}` – обновление пользователя (админ)
- `DELETE /users/{user_id}` – удаление пользователя (админ)

### 4.2. Пациенты
- `POST /patients/` – регистрация пациента
- `GET /patients/{patient_id}` – получение информации о пациенте
- `PUT /patients/{patient_id}` – обновление данных пациента
- `DELETE /patients/{patient_id}` – удаление пациента (админ)

### 4.3. Госпитализация
- `POST /hospitalization/{patient_id}` – госпитализация пациента
- `PATCH /hospitalization/{patient_id}` – изменение статуса
- `DELETE /hospitalization/{patient_id}` – выписка пациента

### 4.4. Медицинская карта
- `POST /medical_records/{patient_id}` – добавление записи
- `GET /medical_records/{patient_id}` – просмотр карты
- `PATCH /medical_records/{record_id}` – обновление записи
- `DELETE /medical_records/{record_id}` – удаление записи (врач)

## 5. Валидация данных
- Email пользователей – формат email
- Пароли – минимум 8 символов, 1 буква, 1 цифра
- Даты – ISO 8601
- Поля медицинских карт – обязательные (диагноз, назначения)

## 6. Структура базы данных (PostgreSQL, SQLAlchemy)
### Таблица `users`
- `id` (UUID, PK)
- `email` (строка, уникальный)
- `password_hash` (строка)
- `role` (enum: admin, doctor, nurse, patient)

### Таблица `patients`
- `id` (UUID, PK)
- `full_name` (строка)
- `birth_date` (дата)
- `gender` (enum: male, female, other)
- `contact_info` (строка)
- `status` (enum: registered, hospitalized, discharged)

### Таблица `hospitalizations`
- `id` (UUID, PK)
- `patient_id` (FK -> patients.id)
- `admission_date` (дата)
- `discharge_date` (дата, nullable)
- `doctor_id` (FK -> users.id)

### Таблица `medical_records`
- `id` (UUID, PK)
- `patient_id` (FK -> patients.id)
- `doctor_id` (FK -> users.id)
- `created_at` (дата-время)
- `diagnosis` (строка)
- `treatment` (строка)

## 7. Развертывание и контейнеризация
- Использование Docker с `docker-compose`
- База данных в отдельном контейнере
- Автоматические миграции Alembic при запуске

## 8. Безопасность
- Хеширование паролей (bcrypt)
- Защита API с помощью JWT-токенов
- Разграничение доступа по ролям
- Логирование действий пользователей

## 9. Тестирование
- Unit-тесты для моделей и сервисов
- Интеграционные тесты API (pytest + httpx)

## 10. Документация
- Автоматическая генерация Swagger UI через FastAPI
- README с инструкцией по запуску

